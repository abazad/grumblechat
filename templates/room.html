{% extends "base.html" %}


{% block heading %}Room: {{ room.name }}{% endblock %}


{% block content %}

    <h3>Topic: 
	    <form action="/room/{{ room.key }}/topic" method="post">
	        <input type="text" name="topic" value="{{ room.topic }}"/>
	        <input type="submit" value="Send"/>
	    </form>
	</h3>

<h3>Chat Log</h3>

<div id="chatlog" class="span-20">
  {% for message in messages %}
    {% include "room_message.html" %}
  {% endfor %}
  {% include "room_message.html" %}
  <form id="text-entry" action="/room/{{ room.key }}/msg" method="post">  
    <div class="span-20 last">
      <div class="span-16 push-4 last">
        <input id="text-entry-content" type="text" name="content" style="width: 560px;" autocomplete="off"/>
        <input id="send-message" type="submit" value="Send"/>
      </div>
    </div>
  </form>
</div>

<div id="sidebar" class="span-4 last">
    <h3>Users</h3>
    <table>
      {% for roomlisting in roomlist %}
      <tr>
        <td>{{ roomlisting.account.gravatar_tag }}
        {{ roomlisting.account.nickname }}</td>
      </tr>
      {% endfor %}
    </table></div>

    <form action="/room/{{ room.key }}/leave" method="post">
      <p>
        <input type="submit" value="Leave Room"/>
      </p>
    </form>

{% endblock %}


{% block script %}
$(function() {
    var url_message_next = '/api/room/{{ room.key }}/msg/?since={{ message_last_key }}';
    var update_interval_min = 1000;
    var update_interval_max = 1000 * 60;
    var update_interval = update_interval_min;

    var $chatlog = $('#chatlog');
    var $msg_template = $chatlog.find('.message').last();

    $('#text-entry').submit(function() {
      var msg = $('#text-entry-content').val();
      sendMessage(msg);
      return false;
    });

    function scrollToBottom() {
        $('html').scrollTop($('html').attr('scrollHeight'));
    }
    function sendMessage(msg) {
        var post_url = '/api/room/{{ room.key }}/msg/';
        $.ajax({
            url: post_url,
            type: "POST",
            data: { message: msg },
            success: function(data) {
                var $msg_new = $msg_template.clone();
                $msg_new.css('display', '');
                $msg_new.find('.msg-timestamp').html(chat.formatTime(chat.parseDate(response.timestamp)));
                $msg_new.find('.msg-sender').html(response.sender_name);
                $msg_new.find('.msg-content').html(response.message);
                $msg_template.before($msg_new);
            },
            error: function() {
                alert("unknown error, try again");
            }
        });
    }
    function updateChat() {
        $.getJSON(url_message_next, function(data) {
            if (data.messages) {
                $.each(data.messages, function(index, message) {
                    var $msg_new = $msg_template.clone();
                    $msg_new.css('display', '');
                    $msg_new.find('.msg-timestamp').html(chat.formatTime(chat.parseDate(message.timestamp)));
                    $msg_new.find('.msg-sender').html('&lt;' + message.sender_name + '&gt;');
                    $msg_new.find('.msg-content').html(message.content);
                    $msg_template.before($msg_new);
                });
                scrollToBottom();
                url_message_next = data.next
                update_interval = update_interval_min;
            } else {
                //temporarily change the backoff from exponential to linear. + 2000 instead of * x
                update_interval = Math.min(update_interval + 2000, update_interval_max);
            }
            setTimeout(updateChat, update_interval);
        });
    }
    setTimeout(updateChat, update_interval);

    scrollToBottom();
    $('#text-entry-content').focus();
});

{% endblock %}
