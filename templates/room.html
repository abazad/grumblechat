{% extends "base.html" %}


{% block heading %}Room: {{ room.name }}{% endblock %}


{% block content %}

    <h3>Topic: 
	    <form action="/room/{{ room.key }}/topic" method="post">
	        <input type="text" name="topic" value="{{ room.topic }}"/>
	        <input type="submit" value="Send"/>
	    </form>
	</h3>

<h3>Chat Log</h3>

<div id="chatlog" class="span-20">
  {% for message in messages %}
  <div class="message">
    <div class="msg-timestamp span-2">{{ message.timestamp|time:"H:i:s" }}</div>
    <div class="msg-sender span-2">&lt;{{ message.sender.nickname }}&gt;</div>
    <div class="msg-content span-16 last">{{ message.content }}</div>
  </div>
  {% endfor %}

  <form id="text-entry" action="/room/{{ room.key }}/msg" method="post">
    <div class="span-20 last">
      <div class="span-16 push-4 last">
        <input type="text" name="content" style="width: 560px;"/>
        <input type="submit" value="Send"/>
      </div>
    </div>
  </form>
</div>

<div id="sidebar" class="span-4 last">
    <h3>Users</h3>
    <table>
      {% for roomlisting in roomlist %}
      <tr>
        <td>{{ roomlisting.account.gravatar_tag }}
        {{ roomlisting.account.nickname }}</td>
      </tr>
      {% endfor %}
    </table></div>

    <form action="/room/{{ room.key }}/leave" method="post">
      <p>
        <input type="submit" value="Leave Room"/>
      </p>
    </form>

{% endblock %}


{% block script %}
$(function() {
    var message_url = '/api/room/{{ room.key }}/msg?since=FIXME need key for last message';

/*    $('#text-entry').submit(function(event) {
        var msg_data = FIXME get message_url;

        var $chatlog = $('#chatlog');
        var $msg_last = $chatlog.find('.message').last(); # FIXME no good if chatlog is empty!
        var $msg = $msg_last.clone();
        $msg.find('.msg-timestamp').html(chat.formatTime(chat.parseDate(msg_data.timestamp)));
        $msg.find('.msg-sender').html('&lt;unknown&gt;');
        $msg.find('.msg-content').html(msg_data.content);
        $msg_last.after($msg);
        
        return false;
    });*/
});
{% endblock %}
